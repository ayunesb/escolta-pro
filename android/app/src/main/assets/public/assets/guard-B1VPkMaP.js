import{l as ue,u as Y,r,s as _,H as Re,j as e,n as Ae,Z as Q,C as b,a as w,S as X,V as I,W as U,a8 as Le,b as Be,B as E,a7 as ke,al as ze,U as A,a0 as S,a1 as T,a2 as je,a3 as Ne,a4 as be,a5 as ye,a6 as $,aa as _e,g as Oe,Q as Ge,c as He,T as Je,A as We,d as Ye,e as Ke,f as Qe,h as Xe,E as Ze,k as es}from"./ErrorBoundary-B6nv__G6.js";import{U as te,B as Fe,a as H,E as ie,g as ss,t as z,L as ts,f as pe}from"./language-toggle-B3OBkquI.js";import{C as de}from"./clock-BpskgTTO.js";import{a as le,j as qe,B as as,M as fe,A as W,x as rs,N as Se,G as ns,P as cs,o as is,C as me,F as Ve,L as ls,U as he,r as ve,l as $e,S as ne,k as oe,D as os,O as ge,u as De,i as Pe,T as Te,p as ds,q as ms,y as us,s as xs,E as hs}from"./alert-SZS2UrZE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fs=ue("Briefcase",[["path",{d:"M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16",key:"jecpp"}],["rect",{width:"20",height:"14",x:"2",y:"6",rx:"2",key:"i6l2r4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=ue("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=ue("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=ue("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=ue("Scan",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const js=ue("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);function Ee(){const{user:s}=Y(),[l,n]=r.useState([]),[m,x]=r.useState(!0);return r.useEffect(()=>{if(!s)return;(async()=>{const{data:c,error:a}=await _.from("assignments").select(`
          *,
          bookings (
            pickup_address,
            start_ts,
            end_ts,
            client_id
          )
        `).eq("guard_id",s.id).order("created_at",{ascending:!1});c&&!a&&n(c),x(!1)})();const t=_.channel("assignments_realtime").on("postgres_changes",{event:"*",schema:"public",table:"assignments",filter:`guard_id=eq.${s.id}`},c=>{c.eventType==="INSERT"?n(a=>[c.new,...a]):c.eventType==="UPDATE"?n(a=>a.map(o=>o.id===c.new.id?c.new:o)):c.eventType==="DELETE"&&n(a=>a.filter(o=>o.id!==c.old.id))}).subscribe();return()=>{_.removeChannel(t)}},[s]),{assignments:l,loading:m,refetch:async()=>{x(!0);try{const{data:i,error:t}=await _.from("assignments").select(`
          *,
          bookings (
            pickup_address,
            start_ts,
            end_ts,
            client_id
          )
        `).eq("guard_id",s.id).order("created_at",{ascending:!1});i&&!t&&n(i)}finally{x(!1)}}}}function Ns(){const{user:s}=Y(),[l,n]=r.useState([]);return r.useEffect(()=>{if(!s)return;const x=_.channel("notifications_realtime").on("postgres_changes",{event:"UPDATE",schema:"public",table:"bookings",filter:`client_id=eq.${s.id}`},i=>{var a,o;const t=(a=i.old)==null?void 0:a.status,c=(o=i.new)==null?void 0:o.status;if(t!==c){const p={id:Date.now(),type:"booking_status_change",title:"Booking Update",message:`Your booking status changed to ${c}`,timestamp:new Date().toISOString(),data:i.new};n(k=>[p,...k].slice(0,10)),"Notification"in window&&Notification.permission==="granted"&&new Notification(p.title,{body:p.message,icon:"/favicon.ico"})}}).subscribe();return()=>{_.removeChannel(x)}},[s]),{notifications:l,requestNotificationPermission:async()=>{"Notification"in window&&Notification.permission==="default"&&await Notification.requestPermission()},clearNotifications:()=>n([])}}const se=({currentPath:s,navigate:l})=>{const{hasRole:n}=Y(),{assignments:m}=Ee(),x=m.filter(a=>a.status==="offered"||a.status==="accepted").length,i=[{id:"home",path:"/home",icon:Re,label:"Home",testId:"nav-home"},{id:"assignments",path:"/assignments",icon:de,label:"Assignments",testId:"nav-assignments",badge:x>0?x:void 0},{id:"bookings",path:"/bookings",icon:le,label:"Bookings",testId:"nav-bookings"},{id:"account",path:"/account",icon:te,label:"Account",testId:"nav-account"}],t=[{id:"company",path:"/company",icon:Fe,label:"Company",testId:"nav-company"}],c=n("company_admin")?[i[0],i[1],i[2],...t,i[3]]:i.filter(a=>a.id!=="bookings");return e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 bg-card border-t border-border safe-bottom z-nav",children:e.jsx("div",{className:"flex max-w-mobile mx-auto",children:c.map(a=>{const o=s===a.path||s.startsWith(a.path+"/");return e.jsxs("button",{"data-testid":a.testId,onClick:()=>l(a.path),className:Ae("flex-1 flex flex-col items-center justify-center touch-target px-1 py-3 transition-colors min-h-[56px] relative",o?"text-accent bg-accent/5":"text-muted-foreground hover:text-foreground"),children:[e.jsxs("div",{className:"relative",children:[e.jsx(a.icon,{className:Ae("h-5 w-5 mb-1",o&&"text-accent")}),a.badge&&e.jsx(H,{variant:"destructive",className:"absolute -top-2 -right-2 h-4 min-w-[16px] text-xs px-1 py-0 flex items-center justify-center",children:a.badge>9?"9+":a.badge})]}),e.jsx("span",{className:"text-xs font-medium leading-none",children:a.label})]},a.id)})})})},Ce=({navigate:s})=>{const{user:l,hasRole:n}=Y(),{assignments:m,loading:x}=Ee(),{notifications:i,requestNotificationPermission:t}=Ns();r.useEffect(()=>{t()},[t]);const c=a=>{switch(a.toLowerCase()){case"offered":return"bg-warning text-black";case"accepted":return"bg-success text-white";case"in_progress":return"bg-accent text-white";case"completed":return"bg-muted text-muted-foreground";default:return"bg-secondary text-secondary-foreground"}};return e.jsxs("div",{className:"min-h-screen bg-background pb-24",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-mobile-xl font-semibold text-foreground",children:"Welcome Back"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:l==null?void 0:l.email})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Q,{variant:"ghost",size:"sm",onClick:()=>s("/account"),hapticPattern:"light",className:"w-10 h-10 bg-muted rounded-full flex items-center justify-center p-0",children:e.jsx(qe,{className:"h-5 w-5 text-muted-foreground"})}),i.length>0&&e.jsxs(Q,{variant:"ghost",size:"sm",onClick:()=>{},hapticPattern:"light",className:"w-10 h-10 bg-accent/10 rounded-full flex items-center justify-center p-0 relative",children:[e.jsx(as,{className:"h-5 w-5 text-accent"}),e.jsx("span",{className:"absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center",children:i.length>9?"9+":i.length})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs(w,{className:"p-4 text-center",onClick:()=>s("/assignments"),children:[e.jsx(le,{className:"h-8 w-8 text-accent mx-auto mb-2"}),e.jsx("h3",{className:"text-mobile-sm font-medium text-foreground",children:"Assignments"})]})}),n("freelancer")&&e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs(w,{className:"p-4 text-center",onClick:()=>s("/apply"),children:[e.jsx(te,{className:"h-8 w-8 text-accent mx-auto mb-2"}),e.jsx("h3",{className:"text-mobile-sm font-medium text-foreground",children:"Apply"})]})}),n("company_admin")&&e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs(w,{className:"p-4 text-center",onClick:()=>s("/security"),children:[e.jsx(X,{className:"h-8 w-8 text-accent mx-auto mb-2"}),e.jsx("h3",{className:"text-mobile-sm font-medium text-foreground",children:"Security"})]})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Recent Assignments"}),m.length>0&&e.jsx("button",{onClick:()=>s("/assignments"),className:"text-accent hover:underline text-mobile-sm",children:"View All"})]}),x?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((a,o)=>e.jsx("div",{className:"h-20 bg-muted animate-pulse rounded-lg"},o))}):m.length===0?e.jsx(b,{children:e.jsxs(w,{className:"p-6 text-center",children:[e.jsx(le,{className:"h-8 w-8 text-muted-foreground mx-auto mb-3"}),e.jsx("h3",{className:"text-mobile-base font-medium text-foreground mb-2",children:"No assignments yet"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Your assignments will appear here"})]})}):e.jsx("div",{className:"space-y-3",children:m.map(a=>{var o,p;return e.jsx(b,{children:e.jsxs(w,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx(H,{className:c(a.status),children:a.status.replace("_"," ").toUpperCase()}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",a.id.slice(-8)]})]}),((o=a.bookings)==null?void 0:o.pickup_address)&&e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(fe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-mobile-sm text-foreground",children:a.bookings.pickup_address})]}),((p=a.bookings)==null?void 0:p.start_ts)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-mobile-sm text-foreground",children:[new Date(a.bookings.start_ts).toLocaleDateString()," at"," ",new Date(a.bookings.start_ts).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})]})]})]})},a.id)})})]})]}),e.jsx(se,{currentPath:"/home",navigate:s})]})},bs=({navigate:s})=>{const{user:l}=Y(),{assignments:n,loading:m}=Ee(),x=t=>{switch(t.toLowerCase()){case"offered":return"bg-warning text-warning-foreground";case"accepted":return"bg-success text-success-foreground";case"in_progress":return"bg-accent text-accent-foreground";case"on_site":return"bg-info text-info-foreground";case"completed":return"bg-muted text-muted-foreground";default:return"bg-secondary text-secondary-foreground"}},i=t=>{s(`/assignment/${t}`)};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>s("/home"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Assignments"}),e.jsx("div",{className:"w-6"})]}),m?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((t,c)=>e.jsx("div",{className:"h-32 bg-muted animate-pulse rounded-lg"},c))}):n.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(le,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-mobile-base font-medium text-foreground mb-2",children:"No assignments yet"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Your assignments will appear here when available"})]}):e.jsx("div",{className:"space-y-4",children:n.map(t=>{var c,a,o;return e.jsxs(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",onClick:()=>i(t.id),children:[e.jsx(I,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(U,{className:"text-mobile-base",children:["Assignment #",t.id.slice(-8)]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{className:x(t.status),children:t.status.replace("_"," ").toUpperCase()}),e.jsx(rs,{className:"h-4 w-4 text-muted-foreground"})]})]})}),e.jsxs(w,{className:"space-y-3",children:[((c=t.bookings)==null?void 0:c.pickup_address)&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(fe,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-mobile-sm text-foreground",children:t.bookings.pickup_address})]}),((a=t.bookings)==null?void 0:a.start_ts)&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(le,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsxs("span",{className:"text-mobile-sm text-foreground",children:[new Date(t.bookings.start_ts).toLocaleDateString()," at"," ",new Date(t.bookings.start_ts).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})]})]}),((o=t.bookings)==null?void 0:o.end_ts)&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(de,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsxs("span",{className:"text-mobile-sm text-foreground",children:["Duration: ",Math.round((new Date(t.bookings.end_ts).getTime()-new Date(t.bookings.start_ts).getTime())/(1e3*60*60)),"h"]})]}),(t.status==="offered"||t.status==="accepted")&&e.jsx("div",{className:"pt-3 border-t",children:e.jsx("div",{className:"text-center",children:e.jsx("span",{className:"text-mobile-sm text-muted-foreground",children:t.status==="offered"?"Tap to respond":"Tap to manage"})})})]})]},t.id)})})]})})},ys=s=>{const[l,n]=r.useState(null),[m,x]=r.useState(!1),[i,t]=r.useState(null),{toast:c}=Le();r.useEffect(()=>{if(!s)return;const u=_.channel(`assignment:${s}`).on("postgres_changes",{event:"*",schema:"public",table:"assignments",filter:`id=eq.${s}`},g=>{const d=g.new,f=Array.isArray(d.gps_trail)?d.gps_trail.filter(h=>h!==null&&typeof h=="object"&&"lat"in h&&"lng"in h&&typeof h.lat=="number"&&typeof h.lng=="number"&&typeof h.timestamp=="string"):[];n({id:d.id,bookingId:d.booking_id,guardId:d.guard_id,status:d.status,checkInTs:d.check_in_ts,checkOutTs:d.check_out_ts,onSiteTs:d.on_site_ts,inProgressTs:d.in_progress_ts,gpsTrail:f})}).subscribe();return a(),()=>{u.unsubscribe()}},[s]);const a=async()=>{if(!s)return;const{data:u,error:g}=await _.from("assignments").select("*").eq("id",s).single();if(g){c({title:"Error",description:"Failed to load assignment",variant:"destructive"});return}const d=Array.isArray(u.gps_trail)?u.gps_trail.filter(f=>f!==null&&typeof f=="object"&&"lat"in f&&"lng"in f&&typeof f.lat=="number"&&typeof f.lng=="number"&&typeof f.timestamp=="string"):[];n({id:u.id,bookingId:u.booking_id,guardId:u.guard_id,status:u.status,checkInTs:u.check_in_ts,checkOutTs:u.check_out_ts,onSiteTs:u.on_site_ts,inProgressTs:u.in_progress_ts,gpsTrail:d})},o=async u=>{if(s)try{const{data:g,error:d}=await _.functions.invoke("assignment_update",{body:{assignmentId:s,status:u,location:i?{lat:i.lat,lng:i.lng}:void 0}});if(d){console.error("Edge function error:",d),c({title:"Error",description:"Failed to update assignment status",variant:"destructive"});return}c({title:"Status Updated",description:g.message||`Assignment status updated to ${u}`})}catch(g){console.error("Update error:",g),c({title:"Error",description:"Failed to update assignment status",variant:"destructive"})}},p=()=>{if(!navigator.geolocation){c({title:"GPS Not Available",description:"Location tracking is not supported",variant:"destructive"});return}x(!0);const u=navigator.geolocation.watchPosition(g=>{const d={lat:g.coords.latitude,lng:g.coords.longitude};t(d),k(d)},g=>{c({title:"GPS Error",description:"Failed to get location",variant:"destructive"}),x(!1)},{enableHighAccuracy:!0,maximumAge:1e4,timeout:5e3});return()=>{navigator.geolocation.clearWatch(u),x(!1)}},k=async u=>{if(!s||!l)return;const g={...u,timestamp:new Date().toISOString()},d=[...l.gpsTrail||[],g],{error:f}=await _.from("assignments").update({gps_trail:d}).eq("id",s);f&&console.error("Failed to update GPS trail:",f)};return{assignment:l,location:i,isTracking:m,updateStatus:o,startLocationTracking:p,loadAssignment:a}},vs=({assignmentId:s,bookingDetails:l})=>{const{assignment:n,location:m,isTracking:x,updateStatus:i,startLocationTracking:t}=ys(s);if(r.useEffect(()=>{if((n==null?void 0:n.status)==="accepted"||(n==null?void 0:n.status)==="in_progress")return t()},[n==null?void 0:n.status]),!n)return e.jsx(b,{children:e.jsx(w,{className:"p-6",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading assignment..."})})});const a=(u=>{switch(u){case"offered":return{color:"bg-info text-info-foreground",icon:de,label:"Assignment Offered"};case"accepted":return{color:"bg-warning text-warning-foreground",icon:Se,label:"En Route"};case"in_progress":return{color:"bg-accent text-accent-foreground",icon:Se,label:"In Progress"};case"on_site":return{color:"bg-success text-success-foreground",icon:fe,label:"On Site"};case"completed":return{color:"bg-success text-success-foreground",icon:Be,label:"Completed"};default:return{color:"bg-muted text-muted-foreground",icon:ns,label:"Unknown"}}})(n.status),o=a.icon,k=(()=>{switch(n.status){case"offered":return{action:()=>i("accepted"),label:"Accept Assignment"};case"accepted":return{action:()=>i("in_progress"),label:"Start Journey"};case"in_progress":return{action:()=>i("on_site"),label:"Arrived On Site"};case"on_site":return{action:()=>i("completed"),label:"Complete Assignment"};default:return null}})();return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(b,{children:[e.jsx(I,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(o,{className:"w-5 h-5"}),"Assignment Status"]}),e.jsx(H,{className:Ae("px-3 py-1",a.color),children:a.label})]})}),e.jsx(w,{className:"pt-0",children:l&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{children:l.address})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs("span",{children:[new Date(l.startTime).toLocaleTimeString(),"(",l.duration,"h duration)"]})]})]})})]}),x&&m&&e.jsxs(b,{children:[e.jsx(I,{className:"pb-3",children:e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"w-5 h-5 text-success"}),"Live Location"]})}),e.jsx(w,{className:"pt-0",children:e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("div",{children:["Lat: ",m.lat.toFixed(6)]}),e.jsxs("div",{children:["Lng: ",m.lng.toFixed(6)]}),e.jsx(H,{variant:"outline",className:"mt-2",children:"GPS Active"})]})})]}),k&&e.jsx(Q,{onClick:k.action,className:"w-full h-12",size:"lg",children:k.label}),e.jsxs(b,{children:[e.jsx(I,{className:"pb-3",children:e.jsx(U,{children:"Timeline"})}),e.jsx(w,{className:"pt-0",children:e.jsxs("div",{className:"space-y-3",children:[n.checkInTs&&e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-success"}),e.jsxs("span",{children:["Accepted: ",new Date(n.checkInTs).toLocaleTimeString()]})]}),n.inProgressTs&&e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-accent"}),e.jsxs("span",{children:["Started: ",new Date(n.inProgressTs).toLocaleTimeString()]})]}),n.onSiteTs&&e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-warning"}),e.jsxs("span",{children:["On Site: ",new Date(n.onSiteTs).toLocaleTimeString()]})]}),n.checkOutTs&&e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-success"}),e.jsxs("span",{children:["Completed: ",new Date(n.checkOutTs).toLocaleTimeString()]})]})]})})]})]})},ws=({navigate:s,assignmentId:l})=>{const[n,m]=r.useState(),[x,i]=r.useState(!0);return r.useEffect(()=>{l&&(async()=>{try{const{data:c,error:a}=await _.from("assignments").select(`
            booking_id,
            bookings (
              pickup_address,
              start_ts,
              end_ts
            )
          `).eq("id",l).single();if(a){console.error("Error fetching assignment details:",a);return}if(c!=null&&c.bookings){const o=c.bookings,p=new Date(o.start_ts),k=new Date(o.end_ts),u=Math.round((k.getTime()-p.getTime())/(1e3*60*60));m({address:o.pickup_address||"Address not available",startTime:o.start_ts,duration:u||4})}}catch(c){console.error("Error fetching booking details:",c)}finally{i(!1)}})()},[l]),x?e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx(Q,{variant:"ghost",size:"sm",onClick:()=>s("/assignments"),hapticPattern:"light",className:"touch-target flex items-center justify-center p-2 -ml-2",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Assignment Details"}),e.jsx("div",{className:"w-10"})]}),e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((t,c)=>e.jsx("div",{className:"h-32 bg-muted animate-pulse rounded-lg"},c))})]})}):e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx(Q,{variant:"ghost",size:"sm",onClick:()=>s("/assignments"),hapticPattern:"light",className:"touch-target flex items-center justify-center p-2 -ml-2",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Assignment Details"}),e.jsx("div",{className:"w-10"})]}),e.jsx(vs,{assignmentId:l,bookingDetails:n})]})})};function ks({navigate:s}){const[l,n]=r.useState("available"),[m,x]=r.useState([]),[i,t]=r.useState(!1);async function c(o){t(!0);try{const{data:p,error:k}=await _.functions.invoke("bookings_guard_list",{body:{scope:o}});if(k)throw k;x(Array.isArray(p)?p:[])}catch(p){console.error("Load error:",p),ke({title:"Error",description:p.message||"Failed to load"})}finally{t(!1)}}r.useEffect(()=>{c(l)},[l]);async function a(o){t(!0);try{const{data:p,error:k}=await _.functions.invoke("booking_accept",{body:{booking_id:o}});if(k)throw k;ke({title:"Assigned",description:"You accepted this job."}),await c("mine"),n("mine")}catch(p){console.error("Accept error:",p),ke({title:"Cannot accept",description:p.message||"Try again"})}finally{t(!1)}}return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"flex items-center justify-between p-4 border-b border-border safe-top",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>s("/account"),className:"p-2",children:e.jsx(W,{className:"h-4 w-4"})}),e.jsx("h1",{className:"text-mobile-lg font-semibold",children:"Guard Jobs"})]})}),e.jsx(cs,{onRefresh:()=>c(l),className:"h-full",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{variant:l==="available"?"default":"outline",onClick:()=>n("available"),className:"flex-1",children:"Available"}),e.jsx(E,{variant:l==="mine"?"default":"outline",onClick:()=>n("mine"),className:"flex-1",children:"My Jobs"})]}),i&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-accent"})}),!i&&m.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(fs,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:l==="available"?"No Available Jobs":"No Assigned Jobs"}),e.jsx("p",{className:"text-muted-foreground",children:l==="available"?"Check back later for new opportunities":"Accept jobs from the Available tab"})]}),e.jsx("div",{className:"space-y-3",children:m.map(o=>e.jsx(b,{className:"overflow-hidden",children:e.jsxs(w,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(fe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-sm",children:o.pickup_address})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(de,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[new Date(o.start_ts).toLocaleDateString()," at"," ",new Date(o.start_ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]}),e.jsxs("div",{className:"text-right",children:[typeof o.total_mxn_cents=="number"&&e.jsx("div",{className:"text-lg font-semibold text-primary",children:is(o.total_mxn_cents)}),e.jsx("div",{className:"text-xs text-muted-foreground capitalize",children:o.status})]})]}),e.jsxs("div",{className:"flex gap-4 mb-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:`h-4 w-4 ${o.armed_required?"text-amber-500":"text-muted-foreground"}`}),e.jsx("span",{className:o.armed_required?"text-amber-600 font-medium":"text-muted-foreground",children:o.armed_required?"Armed":"Unarmed"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(me,{className:`h-4 w-4 ${o.vehicle_required?"text-blue-500":"text-muted-foreground"}`}),e.jsx("span",{className:o.vehicle_required?"text-blue-600 font-medium":"text-muted-foreground",children:o.vehicle_required?"Vehicle":"No vehicle"})]})]}),l==="available"&&e.jsx(E,{onClick:()=>a(o.id),className:"w-full",disabled:i,children:"Accept Job"})]})},o.id))})]})}),e.jsx(se,{currentPath:"/bookings",navigate:s})]})}const _s=({navigate:s})=>{const{user:l,userRoles:n,signOut:m,hasRole:x}=Y(),{theme:i,setTheme:t}=ze(),c=async()=>{try{await m(),A.success("Signed out successfully")}catch{A.error("Error signing out")}},a=()=>{t(i==="dark"?"light":"dark")};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>s("/home"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Account"}),e.jsx("div",{className:"w-6"})]}),e.jsx(b,{className:"mb-6",children:e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-full flex items-center justify-center",children:e.jsx(te,{className:"h-8 w-8 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx(U,{className:"text-mobile-base",children:l==null?void 0:l.email}),e.jsx("div",{className:"flex gap-2 mt-2",children:n.map(o=>e.jsx(H,{variant:"secondary",className:"text-xs",children:o.replace("_"," ").toUpperCase()},o))})]})]})})}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Professional"}),e.jsx(b,{className:"cursor-pointer card-hover",children:e.jsxs(w,{className:"flex items-center gap-4 p-4 touch-target",onClick:()=>s("/assignments"),children:[e.jsx("div",{className:"w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center",children:e.jsx(Ve,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-mobile-base font-medium text-foreground",children:"My Assignments"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"View and manage your assignments"})]})]})}),x("freelancer")&&e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs(w,{className:"flex items-center gap-4 p-4",onClick:()=>s("/apply"),children:[e.jsx("div",{className:"w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center",children:e.jsx(gs,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-mobile-base font-medium text-foreground",children:"Freelancer Application"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Submit or update your application"})]})]})})]}),x("company_admin")&&e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Company Management"}),e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs(w,{className:"flex items-center gap-4 p-4",onClick:()=>s("/company"),children:[e.jsx("div",{className:"w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center",children:e.jsx(Fe,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-mobile-base font-medium text-foreground",children:"Company Profile"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Manage company information"})]})]})}),e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs(w,{className:"flex items-center gap-4 p-4",onClick:()=>s("/company-staff"),children:[e.jsx("div",{className:"w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center",children:e.jsx(te,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-mobile-base font-medium text-foreground",children:"Staff Management"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Manage company staff and guards"})]})]})}),e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs(w,{className:"flex items-center gap-4 p-4",onClick:()=>s("/company-vehicles"),children:[e.jsx("div",{className:"w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center",children:e.jsx(X,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-mobile-base font-medium text-foreground",children:"Vehicle Fleet"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Manage company vehicles"})]})]})})]}),e.jsxs("div",{className:"space-y-4 mb-8",children:[e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Settings"}),e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs(w,{className:"flex items-center gap-4 p-4",onClick:a,children:[e.jsx("div",{className:"w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center",children:e.jsx(qe,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-mobile-base font-medium text-foreground",children:"Theme"}),e.jsxs("p",{className:"text-mobile-sm text-muted-foreground",children:["Currently: ",i==="dark"?"Dark":"Light"," mode"]})]})]})})]}),e.jsxs(Q,{onClick:c,variant:"outline",hapticPattern:"warning",className:"w-full border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground",children:[e.jsx(ls,{className:"h-4 w-4 mr-2"}),"Sign Out"]})]})})},Ss=({navigate:s})=>{const[l,n]=r.useState(!1),[m,x]=r.useState(""),[i,t]=r.useState(""),[c,a]=r.useState(""),[o,p]=r.useState(""),[k,u]=r.useState(""),g=async d=>{d.preventDefault(),n(!0);try{const{error:f}=await _.functions.invoke("company_upsert",{body:{company_name:m,contact_name:i,contact_email:c,tax_id:o,payout_account_id:k}});f?A.error("Failed to update company"):(A.success("Company updated successfully"),s("/account"))}catch{A.error("Failed to update company")}finally{n(!1)}};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>s("/account"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Company Profile"}),e.jsx("div",{className:"w-6"})]}),e.jsxs("form",{onSubmit:g,className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Fe,{className:"h-6 w-6 text-accent"}),e.jsx(U,{className:"text-mobile-base",children:"Company Information"})]})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"companyName",children:"Company Name"}),e.jsx(T,{id:"companyName",type:"text",value:m,onChange:d=>x(d.target.value),className:"input-dark",placeholder:"Enter company name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"taxId",children:"Tax ID"}),e.jsx(T,{id:"taxId",type:"text",value:o,onChange:d=>p(d.target.value),className:"input-dark",placeholder:"Enter tax identification number",required:!0})]})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Contact Information"})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"contactName",children:"Contact Name"}),e.jsx(T,{id:"contactName",type:"text",value:i,onChange:d=>t(d.target.value),className:"input-dark",placeholder:"Enter contact person name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"contactEmail",children:"Contact Email"}),e.jsx(T,{id:"contactEmail",type:"email",value:c,onChange:d=>a(d.target.value),className:"input-dark",placeholder:"Enter contact email",required:!0})]})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Financial Information"})}),e.jsx(w,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"payoutAccountId",children:"Payout Account ID"}),e.jsx(T,{id:"payoutAccountId",type:"text",value:k,onChange:d=>u(d.target.value),className:"input-dark",placeholder:"Enter bank account or payment ID"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Account where payments will be deposited"})]})})]}),e.jsx(E,{type:"submit",disabled:l||!m||!i||!c||!o,className:"w-full h-button rounded-button bg-accent hover:bg-accent/90 text-accent-foreground font-semibold",children:l?"Saving...":"Save Company Profile"})]}),e.jsxs("div",{className:"mt-8 grid grid-cols-2 gap-4",children:[e.jsx(E,{variant:"outline",onClick:()=>s("/company-permits"),className:"h-button",children:"Permits & Licenses"}),e.jsx(E,{variant:"outline",onClick:()=>s("/company-vehicles"),className:"h-button",children:"Vehicle Fleet"})]})]}),e.jsx(se,{currentPath:"/company",navigate:s})]})},Cs=({navigate:s})=>{const{user:l}=Y(),[n,m]=r.useState(!1),[x,i]=r.useState({}),[t,c]=r.useState(null),[a,o]=r.useState(""),[p,k]=r.useState(null),[u,g]=r.useState(""),d=async(y,j)=>{const D=y.name.split(".").pop(),F=`${Date.now()}.${D}`,V=`${j}/${F}`,{error:O}=await _.storage.from("company_docs").upload(V,y);if(O)return console.error("Upload error:",O),null;const{data:q}=await _.storage.from("company_docs").createSignedUrl(V,3600);return(q==null?void 0:q.signedUrl)||null},f=async(y,j)=>{if(!l)return;const D=j;i(q=>({...q,[D]:0}));const F="companies/permits";let V=0;const O=setInterval(()=>{V=Math.min(V+10,90),i(q=>({...q,[D]:V}))},100);try{const q=await d(y,F);clearInterval(O),i(K=>({...K,[D]:100})),q?(j==="insurance"?o(q):g(q),A.success("File uploaded successfully")):A.error("Failed to upload file")}catch{clearInterval(O),i(K=>({...K,[D]:0})),A.error("Failed to upload file")}},h=async y=>{if(y.preventDefault(),!!l){m(!0);try{const{error:j}=await _.functions.invoke("company_permits_upsert",{body:{insurance_doc_url:a,collective_gun_permit_url:u}});j?A.error("Failed to update permits"):(A.success("Permits updated successfully"),s("/company"))}catch{A.error("Failed to update permits")}finally{m(!1)}}};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>s("/company"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Company Permits"}),e.jsx("div",{className:"w-6"})]}),e.jsxs("form",{onSubmit:h,className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"h-6 w-6 text-accent"}),e.jsx(U,{className:"text-mobile-base",children:"Insurance Documentation"})]})}),e.jsx(w,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Upload Insurance Policy"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(E,{type:"button",variant:"outline",className:"flex items-center gap-2",onClick:()=>{var y;return(y=document.getElementById("insurance-doc"))==null?void 0:y.click()},children:[e.jsx(he,{className:"h-4 w-4"}),"Choose File"]}),t&&e.jsx("span",{className:"text-mobile-sm text-muted-foreground",children:t.name})]}),e.jsx("input",{id:"insurance-doc",type:"file",accept:"image/*,.pdf",className:"hidden",onChange:y=>{var D;const j=(D=y.target.files)==null?void 0:D[0];j&&(c(j),f(j,"insurance"))}}),x.insurance!==void 0&&x.insurance<100&&e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-accent h-2 rounded-full transition-all",style:{width:`${x.insurance}%`}})}),a&&e.jsxs(E,{type:"button",variant:"outline",size:"sm",className:"flex items-center gap-2 w-fit",onClick:()=>window.open(a,"_blank"),children:[e.jsx(ie,{className:"h-4 w-4"}),"Preview"]})]})]})})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Collective Gun Permit"})}),e.jsx(w,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Upload Collective Gun Permit"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(E,{type:"button",variant:"outline",className:"flex items-center gap-2",onClick:()=>{var y;return(y=document.getElementById("gun-permit-doc"))==null?void 0:y.click()},children:[e.jsx(he,{className:"h-4 w-4"}),"Choose File"]}),p&&e.jsx("span",{className:"text-mobile-sm text-muted-foreground",children:p.name})]}),e.jsx("input",{id:"gun-permit-doc",type:"file",accept:"image/*,.pdf",className:"hidden",onChange:y=>{var D;const j=(D=y.target.files)==null?void 0:D[0];j&&(k(j),f(j,"gun_permit"))}}),x.gun_permit!==void 0&&x.gun_permit<100&&e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-accent h-2 rounded-full transition-all",style:{width:`${x.gun_permit}%`}})}),u&&e.jsxs(E,{type:"button",variant:"outline",size:"sm",className:"flex items-center gap-2 w-fit",onClick:()=>window.open(u,"_blank"),children:[e.jsx(ie,{className:"h-4 w-4"}),"Preview"]})]})]})})]}),e.jsx(E,{type:"submit",disabled:n,className:"w-full h-button rounded-button bg-accent hover:bg-accent/90 text-accent-foreground font-semibold",children:n?"Saving...":"Save Permits"})]})]}),e.jsx(se,{currentPath:"/company-permits",navigate:s})]})},As=({navigate:s})=>{const{user:l}=Y(),[n,m]=r.useState([]),[x,i]=r.useState(!0);return r.useEffect(()=>{(async()=>{if(l)try{const{data:c}=await _.from("profiles").select("company_id").eq("id",l.id).single();if(c!=null&&c.company_id){const{data:a,error:o}=await _.from("vehicles").select("*").eq("company_id",c.company_id).order("created_at",{ascending:!1});o?console.error("Error fetching vehicles:",o):m(a||[])}}catch(c){console.error("Error fetching vehicles:",c)}finally{i(!1)}})()},[l]),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>s("/company"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Company Vehicles"}),e.jsx("button",{onClick:()=>s("/company-vehicles-new"),className:"touch-target flex items-center justify-center",children:e.jsx(ve,{className:"h-6 w-6 text-accent"})})]}),e.jsxs(E,{onClick:()=>s("/company-vehicles-new"),className:"w-full h-button rounded-button bg-accent hover:bg-accent/90 text-accent-foreground font-semibold mb-6",children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Add New Vehicle"]}),x?e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((t,c)=>e.jsx("div",{className:"h-24 bg-muted animate-pulse rounded-lg"},c))}):n.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(me,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-mobile-base font-medium text-foreground mb-2",children:"No vehicles yet"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground mb-6",children:"Add vehicles to your company fleet"}),e.jsx(E,{onClick:()=>s("/company-vehicles-new"),variant:"outline",children:"Add First Vehicle"})]}):e.jsx("div",{className:"space-y-4",children:n.map(t=>e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",onClick:()=>s(`/company-vehicles/${t.id}`),children:e.jsx(I,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center",children:e.jsx(me,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{children:[e.jsx(U,{className:"text-mobile-base",children:t.type||"Vehicle"}),t.plates&&e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:t.plates})]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[t.armored&&e.jsxs(H,{className:"bg-accent text-accent-foreground",children:[e.jsx(X,{className:"h-3 w-3 mr-1"}),"Armored"]}),e.jsx(H,{variant:t.active?"default":"secondary",className:t.active?"bg-success text-white":"",children:t.active?"Active":"Inactive"})]})]})})},t.id))})]}),e.jsx(se,{currentPath:"/company-vehicles",navigate:s})]})},Ps=({navigate:s})=>{const{user:l}=Y(),[n,m]=r.useState([]),[x,i]=r.useState(!0);return r.useEffect(()=>{(async()=>{if(l)try{const{data:c}=await _.from("profiles").select("company_id").eq("id",l.id).single();if(c!=null&&c.company_id){const{data:a,error:o}=await _.from("guards").select("id, photo_url, user_id").eq("company_id",c.company_id).order("created_at",{ascending:!1});if(o)console.error("Error fetching staff:",o);else{const p=(a==null?void 0:a.map(k=>({id:k.id,name:`Guard ${k.id.slice(-8)}`,email:"",address:"",photo_formal_url:k.photo_url})))||[];m(p)}}}catch(c){console.error("Error fetching staff:",c)}finally{i(!1)}})()},[l]),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>s("/account"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Company Staff"}),e.jsx("button",{onClick:()=>s("/company-staff-new"),className:"touch-target flex items-center justify-center",children:e.jsx(ve,{className:"h-6 w-6 text-accent"})})]}),e.jsxs(E,{onClick:()=>s("/company-staff-new"),className:"w-full h-button rounded-button bg-accent hover:bg-accent/90 text-accent-foreground font-semibold mb-6",children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Add New Staff Member"]}),x?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((t,c)=>e.jsx("div",{className:"h-20 bg-muted animate-pulse rounded-lg"},c))}):n.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(te,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-mobile-base font-medium text-foreground mb-2",children:"No staff members yet"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground mb-6",children:"Add staff members to your company"}),e.jsx(E,{onClick:()=>s("/company-staff-new"),variant:"outline",children:"Add First Staff Member"})]}):e.jsx("div",{className:"space-y-4",children:n.map(t=>e.jsx(b,{className:"cursor-pointer hover:bg-accent/5 transition-colors",onClick:()=>s(`/company-staff/${t.id}`),children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-muted rounded-full flex items-center justify-center",children:t.photo_formal_url?e.jsx("img",{src:t.photo_formal_url,alt:"Staff",className:"w-full h-full rounded-full object-cover"}):e.jsx(te,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-mobile-base font-medium text-foreground",children:t.name||"Staff Member"}),t.email&&e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:t.email})]}),e.jsx(H,{variant:"secondary",children:"Active"})]})})},t.id))})]}),e.jsx(se,{currentPath:"/company-staff",navigate:s})]})},Fs=({navigate:s})=>{const{user:l}=Y(),[n,m]=r.useState(!1),[x,i]=r.useState({}),[t,c]=r.useState(""),[a,o]=r.useState(""),[p,k]=r.useState(""),[u,g]=r.useState("guard"),[d,f]=r.useState(null),[h,y]=r.useState(""),[j,D]=r.useState(null),[F,V]=r.useState(""),[O,q]=r.useState(null),[K,ae]=r.useState(""),ce=async(C,N)=>{const P=C.name.split(".").pop(),G=`${Date.now()}.${P}`,M=`${N}/${G}`,{error:R}=await _.storage.from("company_docs").upload(M,C);if(R)return console.error("Upload error:",R),null;const{data:v}=await _.storage.from("company_docs").createSignedUrl(M,3600);return(v==null?void 0:v.signedUrl)||null},Z=async(C,N)=>{if(!l)return;const P=N;i(v=>({...v,[P]:0}));const G="companies/staff";let M=0;const R=setInterval(()=>{M=Math.min(M+10,90),i(v=>({...v,[P]:M}))},100);try{const v=await ce(C,G);clearInterval(R),i(ee=>({...ee,[P]:100})),v?(N==="id"?y(v):N==="license"?V(v):ae(v),A.success("File uploaded successfully")):A.error("Failed to upload file")}catch{clearInterval(R),i(ee=>({...ee,[P]:0})),A.error("Failed to upload file")}},re=async C=>{if(C.preventDefault(),!!l){m(!0);try{const{data:N}=await _.from("profiles").select("company_id").eq("id",l.id).single();if(!(N!=null&&N.company_id)){A.error("Company ID not found");return}const{error:P}=await _.functions.invoke("company_staff_upsert",{body:{company_id:N.company_id,name:t,email:a,address:p,role:u,id_doc_url:h,driver_license_url:F,photo_formal_url:K}});P?A.error("Failed to add staff member"):(A.success("Staff member added successfully"),s("/company-staff"))}catch{A.error("Failed to add staff member")}finally{m(!1)}}};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>s("/company-staff"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Add Staff Member"}),e.jsx("div",{className:"w-6"})]}),e.jsxs("form",{onSubmit:re,className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"h-6 w-6 text-accent"}),e.jsx(U,{className:"text-mobile-base",children:"Basic Information"})]})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"name",children:"Full Name"}),e.jsx(T,{id:"name",type:"text",value:t,onChange:C=>c(C.target.value),className:"input-dark",placeholder:"Enter full name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"email",children:"Email"}),e.jsx(T,{id:"email",type:"email",value:a,onChange:C=>o(C.target.value),className:"input-dark",placeholder:"Enter email address",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"address",children:"Address"}),e.jsx(T,{id:"address",type:"text",value:p,onChange:C=>k(C.target.value),className:"input-dark",placeholder:"Enter address",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"role",children:"Role"}),e.jsxs("select",{id:"role",value:u,onChange:C=>g(C.target.value),className:"input-dark w-full",required:!0,children:[e.jsx("option",{value:"guard",children:"Security Guard"}),e.jsx("option",{value:"driver",children:"Driver"}),e.jsx("option",{value:"supervisor",children:"Supervisor"}),e.jsx("option",{value:"admin",children:"Administrator"})]})]})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Required Documents"})}),e.jsxs(w,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"ID Document"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(E,{type:"button",variant:"outline",className:"flex items-center gap-2",onClick:()=>{var C;return(C=document.getElementById("id-doc"))==null?void 0:C.click()},children:[e.jsx(he,{className:"h-4 w-4"}),"Choose File"]}),d&&e.jsx("span",{className:"text-mobile-sm text-muted-foreground",children:d.name})]}),e.jsx("input",{id:"id-doc",type:"file",accept:"image/*,.pdf",className:"hidden",onChange:C=>{var P;const N=(P=C.target.files)==null?void 0:P[0];N&&(f(N),Z(N,"id"))}}),x.id!==void 0&&x.id<100&&e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-accent h-2 rounded-full transition-all",style:{width:`${x.id}%`}})}),h&&e.jsxs(E,{type:"button",variant:"outline",size:"sm",className:"flex items-center gap-2 w-fit",onClick:()=>window.open(h,"_blank"),children:[e.jsx(ie,{className:"h-4 w-4"}),"Preview"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Driver's License"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(E,{type:"button",variant:"outline",className:"flex items-center gap-2",onClick:()=>{var C;return(C=document.getElementById("license-doc"))==null?void 0:C.click()},children:[e.jsx(he,{className:"h-4 w-4"}),"Choose File"]}),j&&e.jsx("span",{className:"text-mobile-sm text-muted-foreground",children:j.name})]}),e.jsx("input",{id:"license-doc",type:"file",accept:"image/*,.pdf",className:"hidden",onChange:C=>{var P;const N=(P=C.target.files)==null?void 0:P[0];N&&(D(N),Z(N,"license"))}}),x.license!==void 0&&x.license<100&&e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-accent h-2 rounded-full transition-all",style:{width:`${x.license}%`}})}),F&&e.jsxs(E,{type:"button",variant:"outline",size:"sm",className:"flex items-center gap-2 w-fit",onClick:()=>window.open(F,"_blank"),children:[e.jsx(ie,{className:"h-4 w-4"}),"Preview"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Professional Photo"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(E,{type:"button",variant:"outline",className:"flex items-center gap-2",onClick:()=>{var C;return(C=document.getElementById("photo-doc"))==null?void 0:C.click()},children:[e.jsx(he,{className:"h-4 w-4"}),"Choose File"]}),O&&e.jsx("span",{className:"text-mobile-sm text-muted-foreground",children:O.name})]}),e.jsx("input",{id:"photo-doc",type:"file",accept:"image/*",className:"hidden",onChange:C=>{var P;const N=(P=C.target.files)==null?void 0:P[0];N&&(q(N),Z(N,"photo"))}}),x.photo!==void 0&&x.photo<100&&e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-accent h-2 rounded-full transition-all",style:{width:`${x.photo}%`}})}),K&&e.jsxs(E,{type:"button",variant:"outline",size:"sm",className:"flex items-center gap-2 w-fit",onClick:()=>window.open(K,"_blank"),children:[e.jsx(ie,{className:"h-4 w-4"}),"Preview"]})]})]})]})]}),e.jsx(E,{type:"submit",disabled:n||!t||!a||!p,className:"w-full h-button rounded-button bg-accent hover:bg-accent/90 text-accent-foreground font-semibold",children:n?"Adding...":"Add Staff Member"})]})]}),e.jsx(se,{currentPath:"/company-staff-new",navigate:s})]})},Es=({navigate:s,staffId:l})=>{var re,C;const[n,m]=r.useState(null),[x,i]=r.useState(!0),[t,c]=r.useState(!1),[a,o]=r.useState(!1),[p,k]=r.useState(""),[u,g]=r.useState(""),[d,f]=r.useState(!0),[h,y]=r.useState(!1),[j,D]=r.useState(!1),[F,V]=r.useState(""),[O,q]=r.useState(""),[K,ae]=r.useState("");r.useEffect(()=>{const N=async()=>{var G,M,R;try{const{data:v,error:ee}=await _.from("guards").select("*").eq("id",l).single();if(ee){console.error("Error fetching staff member:",ee),A.error("Failed to load staff member"),s("/company-staff");return}m(v),k(((G=v.hourly_rate)==null?void 0:G.toString())||""),g(v.city||""),f(v.active??!0),y(((M=v.skills)==null?void 0:M.armed)??!1),D(((R=v.skills)==null?void 0:R.driver)??!1),P(v.id)}catch(v){console.error("Error fetching staff member:",v),A.error("Failed to load staff member"),s("/company-staff")}finally{i(!1)}},P=async G=>{try{const{data:M}=await _.from("guard_documents").select("*").eq("guard_id",G);M&&M.forEach(R=>{switch(R.doc_type){case"id":V(R.url||"");break;case"gun_permit":q(R.url||"");break;case"driver_license":ae(R.url||"");break}})}catch(M){console.error("Error fetching documents:",M)}};l&&N()},[l,s]);const ce=async()=>{if(n){o(!0);try{const{error:N}=await _.from("guards").update({hourly_rate:p?parseFloat(p):null,city:u,active:d,skills:{...n.skills,armed:h,driver:j}}).eq("id",l);if(N)throw N;A.success("Staff member updated successfully"),c(!1),m(P=>P?{...P,hourly_rate:p?parseFloat(p):void 0,city:u,active:d,skills:{...P.skills,armed:h,driver:j}}:null)}catch(N){console.error("Error updating staff member:",N),A.error("Failed to update staff member")}finally{o(!1)}}},Z=async(N,P)=>{if(n)try{const{error:G}=await _.from("guard_documents").upsert({guard_id:n.id,doc_type:P,url:N,created_at:new Date().toISOString()});if(G)throw G;switch(P){case"id":V(N);break;case"gun_permit":q(N);break;case"driver_license":ae(N);break}}catch(G){console.error("Error saving document:",G),A.error("Failed to save document")}};return x?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-accent"})}):n?e.jsxs("div",{className:"min-h-screen bg-background pb-24",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>s("/company-staff"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-mobile-xl font-semibold text-foreground",children:"Staff Member"}),e.jsxs("p",{className:"text-mobile-sm text-muted-foreground",children:["ID: ",l.slice(-8)]})]})]}),e.jsx(E,{onClick:t?ce:()=>c(!0),disabled:a,className:"rounded-button",children:t?e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),a?"Saving...":"Save"]}):e.jsxs(e.Fragment,{children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),"Edit"]})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(U,{className:"text-mobile-base",children:"Staff Information"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{variant:n.active?"default":"secondary",className:n.active?"bg-success text-white":"",children:n.active?"Active":"Inactive"}),e.jsxs(H,{variant:"outline",children:["Rating: ",n.rating.toFixed(1)]})]})]})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-mobile-sm font-medium",children:"Hourly Rate"}),t?e.jsx(T,{type:"number",value:p,onChange:N=>k(N.target.value),placeholder:"Enter hourly rate",className:"input-dark"}):e.jsx("p",{className:"text-mobile-sm text-foreground",children:p?`$${p}/hr`:"Not set"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-mobile-sm font-medium",children:"City"}),t?e.jsx(T,{type:"text",value:u,onChange:N=>g(N.target.value),placeholder:"Enter city",className:"input-dark"}):e.jsx("p",{className:"text-mobile-sm text-foreground",children:u||"Not set"})]})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(S,{children:"Active Status"})]}),e.jsx(ne,{checked:d,onCheckedChange:f})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(S,{children:"Armed Personnel"})]}),e.jsx(ne,{checked:h,onCheckedChange:y})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(S,{children:"With Vehicle"})]}),e.jsx(ne,{checked:j,onCheckedChange:D})]})]})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Documents"})}),e.jsxs(w,{className:"space-y-6",children:[e.jsx(oe,{label:"Government ID",bucketName:"licenses",storagePath:`guards/${n.id}`,currentFileUrl:F,onUploadComplete:N=>Z(N,"id"),accept:".pdf,.jpg,.jpeg,.png",required:!0}),(h||((re=n.skills)==null?void 0:re.armed))&&e.jsx(oe,{label:"Gun Permit",bucketName:"licenses",storagePath:`guards/${n.id}`,currentFileUrl:O,onUploadComplete:N=>Z(N,"gun_permit"),accept:".pdf,.jpg,.jpeg,.png",required:!0}),(j||((C=n.skills)==null?void 0:C.driver))&&e.jsx(oe,{label:"Driver's License",bucketName:"licenses",storagePath:`guards/${n.id}`,currentFileUrl:K,onUploadComplete:N=>Z(N,"driver_license"),accept:".pdf,.jpg,.jpeg,.png",required:!0})]})]})]})]}),e.jsx(se,{currentPath:"/company-staff",navigate:s})]}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-mobile-lg font-medium text-foreground mb-2",children:"Staff member not found"}),e.jsx(E,{onClick:()=>s("/company-staff"),children:"Back to Staff"})]})})},Ue=({navigate:s,vehicleId:l})=>{const{user:n}=Y(),[m,x]=r.useState(!1),[i,t]=r.useState(null),[c,a]=r.useState(!!l),[o,p]=r.useState(""),[k,u]=r.useState(""),[g,d]=r.useState(""),[f,h]=r.useState(""),[y,j]=r.useState(""),[D,F]=r.useState(""),[V,O]=r.useState(!1),[q,K]=r.useState("None"),[ae,ce]=r.useState(!0),[Z,re]=r.useState(!1),[C,N]=r.useState(""),[P,G]=r.useState(""),[M,R]=r.useState("");r.useEffect(()=>{l&&v()},[l]);const v=async()=>{var L;if(l)try{const{data:B,error:xe}=await _.from("vehicles").select("*").eq("id",l).maybeSingle();if(xe){console.error("Error loading vehicle:",xe),A.error("Failed to load vehicle"),s("/company-vehicles");return}if(B){t(B),p(B.type||""),F(B.plates||""),O(B.armored??!1),ce(B.active??!0);const J=B.docs;J&&(u(J.make||""),d(J.model||""),h(((L=J.year)==null?void 0:L.toString())||""),j(J.color||""),K(J.armored_level||"None"),re(J.armed_deployment_ready??!1),N(J.photo_url||""),G(J.registration_url||""),R(J.insurance_url||""))}}catch(B){console.error("Error loading vehicle:",B)}},ee=async L=>{if(L.preventDefault(),!!n){if(!o||!k||!g){A.error("Please fill in all required fields");return}x(!0);try{const{data:B}=await _.from("profiles").select("company_id").eq("id",n.id).maybeSingle();if(!(B!=null&&B.company_id)){A.error("Company profile not found");return}const xe={company_id:B.company_id,type:o,plates:D,armored:V,active:ae,owned_by:"company",docs:{make:k,model:g,year:f?parseInt(f):null,color:y,armored_level:q,armed_deployment_ready:Z,photo_url:C,registration_url:P,insurance_url:M}};if(c&&l){const{error:J}=await _.from("vehicles").update(xe).eq("id",l);if(J)throw J;A.success("Vehicle updated successfully")}else{const{error:J}=await _.from("vehicles").insert(xe);if(J)throw J;A.success("Vehicle added successfully")}s("/company-vehicles")}catch(B){console.error("Error saving vehicle:",B),A.error("Failed to save vehicle")}finally{x(!1)}}},we=(L,B)=>{switch(B){case"photo":N(L);break;case"registration":G(L);break;case"insurance":R(L);break}};return e.jsxs("div",{className:"min-h-screen bg-background pb-24",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>s("/company-vehicles"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-mobile-xl font-semibold text-foreground",children:c?"Edit Vehicle":"Add Vehicle"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:c?"Update vehicle information":"Add a new company vehicle"})]})]})}),e.jsxs("form",{onSubmit:ee,className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Vehicle Details"})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-mobile-sm font-medium",children:"Vehicle Type *"}),e.jsxs(je,{value:o,onValueChange:p,children:[e.jsx(Ne,{className:"input-dark",children:e.jsx(be,{placeholder:"Select vehicle type"})}),e.jsxs(ye,{children:[e.jsx($,{value:"Sedan",children:"Sedan"}),e.jsx($,{value:"SUV",children:"SUV"}),e.jsx($,{value:"Van",children:"Van"}),e.jsx($,{value:"Bike",children:"Motorcycle"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"make",children:"Make *"}),e.jsx(T,{id:"make",type:"text",value:k,onChange:L=>u(L.target.value),className:"input-dark",placeholder:"e.g., Toyota",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"model",children:"Model *"}),e.jsx(T,{id:"model",type:"text",value:g,onChange:L=>d(L.target.value),className:"input-dark",placeholder:"e.g., Camry",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"year",children:"Year"}),e.jsx(T,{id:"year",type:"number",value:f,onChange:L=>h(L.target.value),className:"input-dark",placeholder:"e.g., 2022",min:"1990",max:new Date().getFullYear()+1})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"color",children:"Color"}),e.jsx(T,{id:"color",type:"text",value:y,onChange:L=>j(L.target.value),className:"input-dark",placeholder:"e.g., Black"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"plates",children:"License Plates"}),e.jsx(T,{id:"plates",type:"text",value:D,onChange:L=>F(L.target.value),className:"input-dark",placeholder:"Enter license plate number"})]})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Security Features"})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(S,{children:"Armored Vehicle"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ballistic protection installed"})]})]}),e.jsx(ne,{checked:V,onCheckedChange:O})]}),V&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{className:"text-mobile-sm font-medium",children:"Armor Level"}),e.jsxs(je,{value:q,onValueChange:K,children:[e.jsx(Ne,{className:"input-dark",children:e.jsx(be,{placeholder:"Select armor level"})}),e.jsxs(ye,{children:[e.jsx($,{value:"NIJ II",children:"NIJ Level II"}),e.jsx($,{value:"NIJ IIIA",children:"NIJ Level IIIA"}),e.jsx($,{value:"NIJ III",children:"NIJ Level III"}),e.jsx($,{value:"NIJ IV",children:"NIJ Level IV"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(S,{children:"Armed Deployment Ready"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Can support armed personnel"})]})]}),e.jsx(ne,{checked:Z,onCheckedChange:re})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsx(S,{children:"Active Status"}),e.jsx(ne,{checked:ae,onCheckedChange:ce})]})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Vehicle Documents"})}),e.jsxs(w,{className:"space-y-6",children:[e.jsx(oe,{label:"Vehicle Photo",bucketName:"vehicles",storagePath:`company/${n==null?void 0:n.id}`,currentFileUrl:C,onUploadComplete:L=>we(L,"photo"),accept:".jpg,.jpeg,.png"}),e.jsx(oe,{label:"Vehicle Registration",bucketName:"vehicles",storagePath:`company/${n==null?void 0:n.id}`,currentFileUrl:P,onUploadComplete:L=>we(L,"registration"),accept:".pdf,.jpg,.jpeg,.png"}),e.jsx(oe,{label:"Insurance Certificate",bucketName:"vehicles",storagePath:`company/${n==null?void 0:n.id}`,currentFileUrl:M,onUploadComplete:L=>we(L,"insurance"),accept:".pdf,.jpg,.jpeg,.png"})]})]}),e.jsxs(E,{type:"submit",disabled:m||!o||!k||!g,className:"w-full h-button rounded-button bg-accent hover:bg-accent/90 text-accent-foreground font-semibold",children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),m?"Saving...":c?"Update Vehicle":"Add Vehicle"]})]})]}),e.jsx(se,{currentPath:"/company-vehicles",navigate:s})]})},Ds=({navigate:s})=>{const[l,n]=r.useState(!1),[m]=r.useState(ss()),[x,i]=r.useState(""),[t,c]=r.useState(""),[a,o]=r.useState(""),[p,k]=r.useState(""),[u,g]=r.useState(!1),[d,f]=r.useState(!1),[h,y]=r.useState(8e4),[j,D]=r.useState(2e4),[F,V]=r.useState(35e4),[O,q]=r.useState(15e4),[K,ae]=r.useState(""),[ce,Z]=r.useState(""),[re,C]=r.useState(""),[N,P]=r.useState(""),[G,M]=r.useState(""),R=async v=>{if(v.preventDefault(),!x||!t||!a){A.error("Please fill in all required fields");return}n(!0);try{const{error:ee}=await _.functions.invoke("freelancer_apply",{body:{name:x,email:t,phone:p,address:a,armed:u,with_vehicle:d,hourly_rate_mxn_cents:h,armed_hourly_surcharge_mxn_cents:j,vehicle_hourly_rate_mxn_cents:d?F:null,armored_hourly_surcharge_mxn_cents:d?O:null}});ee?A.error("Failed to submit application"):(A.success("Application submitted successfully"),s("/account"))}catch{A.error("Failed to submit application")}finally{n(!1)}};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>s("/account"),className:"touch-target flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:z("book_protector",m)}),e.jsx(ts,{})]}),e.jsxs("form",{onSubmit:R,className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"h-6 w-6 text-accent"}),e.jsx(U,{className:"text-mobile-base",children:z("personal_info",m)})]})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"name",children:z("name",m)}),e.jsx(T,{id:"name",value:x,onChange:v=>i(v.target.value),className:"input-dark",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"email",children:z("email",m)}),e.jsx(T,{id:"email",type:"email",value:t,onChange:v=>c(v.target.value),className:"input-dark",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"phone",children:z("phone",m)}),e.jsx(T,{id:"phone",type:"tel",value:p,onChange:v=>k(v.target.value),className:"input-dark",placeholder:z("phone",m)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"address",children:z("address",m)}),e.jsx(T,{id:"address",value:a,onChange:v=>o(v.target.value),className:"input-dark",required:!0})]})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(os,{className:"h-6 w-6 text-accent"}),e.jsx(U,{className:"text-mobile-base",children:z("pricing",m)})]})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"hourlyRate",children:z("hourly_rate_mxn",m)}),e.jsx(T,{id:"hourlyRate",type:"number",value:h/100,onChange:v=>y(Math.round(parseFloat(v.target.value||"0")*100)),className:"input-dark",min:"0",step:"0.01"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[pe(h)," ",z("hourly_rate_mxn",m).toLowerCase()]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"armedSurcharge",children:z("armed_surcharge_mxn",m)}),e.jsx(T,{id:"armedSurcharge",type:"number",value:j/100,onChange:v=>D(Math.round(parseFloat(v.target.value||"0")*100)),className:"input-dark",min:"0",step:"0.01"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["+",pe(j)," ",z("armed_surcharge_mxn",m).toLowerCase()]})]}),d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"vehicleRate",children:z("vehicle_hourly_mxn",m)}),e.jsx(T,{id:"vehicleRate",type:"number",value:F/100,onChange:v=>V(Math.round(parseFloat(v.target.value||"0")*100)),className:"input-dark",min:"0",step:"0.01"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[pe(F)," ",z("vehicle_hourly_mxn",m).toLowerCase()]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"armoredSurcharge",children:z("armored_surcharge_mxn",m)}),e.jsx(T,{id:"armoredSurcharge",type:"number",value:O/100,onChange:v=>q(Math.round(parseFloat(v.target.value||"0")*100)),className:"input-dark",min:"0",step:"0.01"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["+",pe(O)," ",z("armored_surcharge_mxn",m).toLowerCase()]})]})]})]})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsx(U,{className:"text-mobile-base",children:"Capabilities"})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(S,{children:z("armed_required",m)})]}),e.jsx(ne,{checked:u,onCheckedChange:g})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(S,{children:z("vehicle_required",m)})]}),e.jsx(ne,{checked:d,onCheckedChange:f})]})]})]}),e.jsx(E,{type:"submit",disabled:l||!x||!t||!a,className:"w-full h-button rounded-button bg-accent hover:bg-accent/90 text-accent-foreground font-semibold",children:l?"Submitting...":"Submit Application"})]})]}),e.jsx(se,{currentPath:"/apply",navigate:s})]})},Ts=()=>{const[s,l]=r.useState([]),[n,m]=r.useState({totalAlerts:0,criticalAlerts:0,activeIncidents:0}),[x,i]=r.useState(!0),{toast:t}=Le(),{user:c}=Y(),a=r.useCallback(async()=>{if(c)try{const{data:g,error:d}=await _.from("audit_logs").select("*").in("action",["failed_login","unusual_activity","data_access","permission_change"]).order("ts",{ascending:!1}).limit(50);if(d){console.error("Error fetching security alerts:",d);return}const f=g.map(j=>({id:j.id.toString(),type:j.action,severity:o(j.action),message:p(j),timestamp:j.ts,userId:j.actor_id,metadata:j.diff&&typeof j.diff=="object"?j.diff:{}}));l(f);const h=f.filter(j=>j.severity==="critical").length,y=f.filter(j=>j.timestamp>new Date(Date.now()-24*60*60*1e3).toISOString()).length;m({totalAlerts:f.length,criticalAlerts:h,activeIncidents:y,lastScanTime:new Date().toISOString()})}catch(g){console.error("Error in security monitoring:",g)}finally{i(!1)}},[c]),o=g=>{switch(g){case"failed_login":return"medium";case"unusual_activity":return"high";case"data_access":return"low";case"permission_change":return"critical";default:return"low"}},p=g=>{switch(g.action){case"failed_login":return"Failed login attempt detected";case"unusual_activity":return"Unusual activity pattern detected";case"data_access":return"Sensitive data accessed";case"permission_change":return"User permissions modified";default:return`Security event: ${g.action}`}},k=async g=>{try{await _.from("audit_logs").update({diff:{acknowledged:!0,acknowledged_by:c==null?void 0:c.id,acknowledged_at:new Date().toISOString()}}).eq("id",parseInt(g)),l(d=>d.filter(f=>f.id!==g)),t({title:"Alert Acknowledged",description:"Security alert has been acknowledged"})}catch(d){console.error("Error acknowledging alert:",d),t({title:"Error",description:"Failed to acknowledge alert",variant:"destructive"})}},u=async()=>{try{i(!0);const{data:g,error:d}=await _.functions.invoke("security_scan",{body:{scan_type:"comprehensive"}});if(d)throw d;t({title:"Security Scan Complete",description:`Scan completed. Found ${g.issues_count||0} potential issues.`}),await a()}catch(g){console.error("Error running security scan:",g),t({title:"Scan Failed",description:"Security scan could not be completed",variant:"destructive"})}finally{i(!1)}};return r.useEffect(()=>{a();const g=_.channel("security-alerts").on("postgres_changes",{event:"INSERT",schema:"public",table:"audit_logs",filter:"action=in.(failed_login,unusual_activity,data_access,permission_change)"},d=>{const f={id:d.new.id.toString(),type:d.new.action,severity:o(d.new.action),message:p(d.new),timestamp:d.new.ts,userId:d.new.actor_id,metadata:d.new.diff};l(h=>[f,...h]),(f.severity==="critical"||f.severity==="high")&&t({title:"Security Alert",description:f.message,variant:"destructive"})}).subscribe();return()=>{g.unsubscribe()}},[a,t,c]),{alerts:s,metrics:n,loading:x,acknowledgeAlert:k,runSecurityScan:u,refreshAlerts:a}},Is=({navigate:s})=>{const{alerts:l,metrics:n,loading:m,acknowledgeAlert:x,runSecurityScan:i}=Ts(),t=a=>{switch(a){case"critical":return"bg-destructive text-destructive-foreground";case"high":return"bg-orange-500 text-white";case"medium":return"bg-warning text-warning-foreground";case"low":return"bg-muted text-muted-foreground";default:return"bg-secondary text-secondary-foreground"}},c=a=>{switch(a){case"critical":case"high":return _e;case"medium":return ie;case"low":return De;default:return X}};return m?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ge,{type:"list-item",className:"h-32"}),e.jsx(ge,{type:"list-item",className:"h-48"}),e.jsx(ge,{type:"list-item",className:"h-64"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Total Alerts"}),e.jsx("p",{className:"text-mobile-lg font-semibold text-foreground",children:n.totalAlerts})]}),e.jsx(X,{className:"h-8 w-8 text-accent"})]})})}),e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Critical"}),e.jsx("p",{className:"text-mobile-lg font-semibold text-destructive",children:n.criticalAlerts})]}),e.jsx(_e,{className:"h-8 w-8 text-destructive"})]})})}),e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Active (24h)"}),e.jsx("p",{className:"text-mobile-lg font-semibold text-warning",children:n.activeIncidents})]}),e.jsx(De,{className:"h-8 w-8 text-warning"})]})})}),e.jsx(b,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Last Scan"}),e.jsx("p",{className:"text-mobile-sm font-medium text-muted-foreground",children:n.lastScanTime?Pe(new Date(n.lastScanTime),{addSuffix:!0}):"Never"})]}),e.jsx(Ie,{className:"h-8 w-8 text-muted-foreground"})]})})})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"h-5 w-5"}),"Security Actions"]})}),e.jsx(w,{children:e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(Q,{onClick:i,variant:"outline",size:"sm",hapticPattern:"medium",className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4"}),"Run Security Scan"]}),e.jsxs(Q,{onClick:()=>s==null?void 0:s("/audit-trail"),variant:"outline",size:"sm",hapticPattern:"light",className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-4 w-4"}),"View Audit Trail"]}),e.jsxs(Q,{onClick:()=>s==null?void 0:s("/security"),variant:"outline",size:"sm",hapticPattern:"light",className:"flex items-center gap-2",children:[e.jsx(Te,{className:"h-4 w-4"}),"Security Settings"]})]})})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"h-5 w-5"}),"Recent Security Alerts"]}),l.length>5&&e.jsx("button",{onClick:()=>s==null?void 0:s("/security-alerts"),className:"text-accent hover:underline text-mobile-sm",children:"View All"})]})}),e.jsx(w,{children:l.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(X,{className:"h-12 w-12 text-muted-foreground mx-auto mb-3"}),e.jsx("h3",{className:"text-mobile-base font-medium text-foreground mb-2",children:"No Security Alerts"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Your system is secure. All security checks passed."})]}):e.jsx("div",{className:"space-y-3",children:l.slice(0,5).map(a=>{const o=c(a.severity);return e.jsxs(ds,{className:"relative",children:[e.jsx(o,{className:"h-4 w-4"}),e.jsx(ms,{className:"pr-20",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(H,{className:t(a.severity),children:a.severity.toUpperCase()}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Pe(new Date(a.timestamp),{addSuffix:!0})})]}),e.jsx("p",{className:"text-mobile-sm font-medium text-foreground",children:a.message}),a.metadata&&e.jsx("div",{className:"mt-2 text-xs text-muted-foreground",children:e.jsxs("code",{className:"bg-muted px-2 py-1 rounded",children:[JSON.stringify(a.metadata,null,2).slice(0,100),"..."]})})]}),e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>x(a.id),className:"absolute top-2 right-2",children:"Dismiss"})]})})]},a.id)})})})]}),e.jsxs(b,{children:[e.jsx(I,{children:e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"h-5 w-5"}),"Security Health"]})}),e.jsx(w,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"}),e.jsx("span",{className:"text-mobile-sm font-medium",children:"Authentication Security"})]}),e.jsx(H,{variant:"outline",className:"text-green-600 border-green-200",children:"Healthy"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"}),e.jsx("span",{className:"text-mobile-sm font-medium",children:"Database Security"})]}),e.jsx(H,{variant:"outline",className:"text-green-600 border-green-200",children:"Healthy"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-yellow-500"}),e.jsx("span",{className:"text-mobile-sm font-medium",children:"Access Control"})]}),e.jsx(H,{variant:"outline",className:"text-yellow-600 border-yellow-200",children:"Review Needed"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"}),e.jsx("span",{className:"text-mobile-sm font-medium",children:"Data Encryption"})]}),e.jsx(H,{variant:"outline",className:"text-green-600 border-green-200",children:"Healthy"})]})]})})]})]})},Us=({navigate:s})=>e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx(Q,{variant:"ghost",size:"sm",onClick:()=>s("/company"),hapticPattern:"light",className:"touch-target flex items-center justify-center p-2 -ml-2",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Security Dashboard"}),e.jsx("div",{className:"w-10"})]}),e.jsx(Is,{navigate:s})]})}),Ls=()=>{const[s,l]=r.useState([]),[n,m]=r.useState(!1),[x,i]=r.useState(0),{user:t}=Y(),c=r.useCallback(async(u={},g=0,d=50)=>{if(t){m(!0);try{let f=_.from("audit_logs").select(`
          id,
          action,
          entity,
          entity_id,
          actor_id,
          ts,
          diff,
          profiles!audit_logs_actor_id_fkey (email)
        `,{count:"exact"}).order("ts",{ascending:!1}).range(g*d,(g+1)*d-1);u.startDate&&(f=f.gte("ts",u.startDate)),u.endDate&&(f=f.lte("ts",u.endDate)),u.action&&(f=f.eq("action",u.action)),u.entity&&(f=f.eq("entity",u.entity)),u.actorId&&(f=f.eq("actor_id",u.actorId));const{data:h,error:y,count:j}=await f;if(y){console.error("Error fetching audit entries:",y);return}const D=(h||[]).map(F=>{var V;return{id:F.id.toString(),action:F.action||"",entity:F.entity||"",entityId:F.entity_id||"",actorId:F.actor_id||"",timestamp:F.ts||"",changes:F.diff&&typeof F.diff=="object"?F.diff:{},actorEmail:(V=F.profiles)==null?void 0:V.email}});l(g===0?D:F=>[...F,...D]),i(j||0)}catch(f){console.error("Error in audit trail fetch:",f)}finally{m(!1)}}},[t]),a=r.useCallback(async(u,g,d,f={})=>{if(t)try{await _.from("audit_logs").insert({actor_id:t.id,action:u,entity:g,entity_id:d,diff:f})}catch(h){console.error("Error logging audit entry:",h)}},[t]),o=r.useCallback(async(u={},g="csv")=>{try{const d=await _.functions.invoke("export_audit_log",{body:{filters:u,format:g}});if(d.error)throw d.error;const f=new Blob([d.data.content],{type:g==="csv"?"text/csv":"application/json"}),h=window.URL.createObjectURL(f),y=document.createElement("a");y.href=h,y.download=`audit-log-${new Date().toISOString().split("T")[0]}.${g}`,document.body.appendChild(y),y.click(),document.body.removeChild(y),window.URL.revokeObjectURL(h)}catch(d){throw console.error("Error exporting audit log:",d),d}},[]),p=u=>{switch(u.toLowerCase()){case"create":case"insert":return"text-green-600 bg-green-50";case"update":case"modify":return"text-blue-600 bg-blue-50";case"delete":case"remove":return"text-red-600 bg-red-50";case"login":case"access":return"text-purple-600 bg-purple-50";case"failed_login":case"error":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}},k=u=>{const{action:g,entity:d,changes:f}=u;switch(g){case"booking_create":return`Created new booking for ${f.pickup_address||"unknown location"}`;case"assignment_status_update":return`Updated assignment status from ${f.previous_status} to ${f.new_status}`;case"user_login":return"User signed in";case"failed_login":return"Failed login attempt";case"profile_update":return"Updated profile information";case"company_create":return`Created company: ${f.name||"unnamed"}`;case"guard_create":return"Added new guard to system";case"document_upload":return`Uploaded document: ${f.doc_type||"unknown type"}`;case"incident_report":return`Reported incident: ${f.type||"general"}`;default:return`${g.replace("_"," ")} on ${d}`}};return r.useEffect(()=>{c()},[c]),{entries:s,loading:n,totalCount:x,fetchAuditEntries:c,logAuditEntry:a,exportAuditLog:o,getActionColor:p,formatActionDescription:k}},qs=({navigate:s})=>{const{entries:l,loading:n,totalCount:m,fetchAuditEntries:x,exportAuditLog:i,getActionColor:t,formatActionDescription:c}=Ls(),[a,o]=r.useState({action:"",entity:"",startDate:"",endDate:"",search:""}),[p,k]=r.useState(!1),u=(h,y)=>{const j={...a,[h]:y};o(j);const D=setTimeout(()=>{x(j,0,50)},300);return()=>clearTimeout(D)},g=async h=>{try{await i(a,h)}catch(y){console.error("Export failed:",y)}},d=()=>{const h={action:"",entity:"",startDate:"",endDate:"",search:""};o(h),x(h,0,50)},f=({item:h,index:y})=>e.jsx(b,{className:"mb-3",children:e.jsxs(w,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`px-2 py-1 rounded-md text-xs font-medium ${t(h.action)}`,children:h.action.replace("_"," ").toUpperCase()}),e.jsx(H,{variant:"outline",className:"text-xs",children:h.entity})]}),e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(de,{className:"h-3 w-3"}),Pe(new Date(h.timestamp),{addSuffix:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-mobile-sm font-medium text-foreground",children:c(h)}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(te,{className:"h-3 w-3"}),e.jsx("span",{children:h.actorEmail||h.actorId}),h.entityId&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["ID: ",h.entityId.slice(-8)]})]})]}),Object.keys(h.changes).length>0&&e.jsxs("details",{className:"mt-2",children:[e.jsxs("summary",{className:"text-xs text-accent cursor-pointer hover:underline",children:["View Changes (",Object.keys(h.changes).length," fields)"]}),e.jsx("div",{className:"mt-2 p-3 bg-muted rounded-md",children:e.jsx("pre",{className:"text-xs text-muted-foreground overflow-x-auto",children:JSON.stringify(h.changes,null,2)})})]})]})]})},h.id);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b,{children:[e.jsxs(I,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5"}),"Audit Trail"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Q,{variant:"outline",size:"sm",onClick:()=>k(!p),hapticPattern:"light",className:"flex items-center gap-2",children:[e.jsx(us,{className:"h-4 w-4"}),"Filters"]}),e.jsxs(Q,{variant:"outline",size:"sm",onClick:()=>g("csv"),hapticPattern:"light",className:"flex items-center gap-2",children:[e.jsx(xs,{className:"h-4 w-4"}),"Export"]})]})]}),e.jsxs("div",{className:"text-mobile-sm text-muted-foreground",children:[m.toLocaleString()," total entries"]})]}),p&&e.jsx(w,{className:"border-t",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-mobile-sm font-medium",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(hs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(T,{placeholder:"Search entries...",value:a.search,onChange:h=>u("search",h.target.value),className:"pl-9"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-mobile-sm font-medium",children:"Action"}),e.jsxs(je,{value:a.action,onValueChange:h=>u("action",h),children:[e.jsx(Ne,{children:e.jsx(be,{placeholder:"All actions"})}),e.jsxs(ye,{children:[e.jsx($,{value:"",children:"All actions"}),e.jsx($,{value:"create",children:"Create"}),e.jsx($,{value:"update",children:"Update"}),e.jsx($,{value:"delete",children:"Delete"}),e.jsx($,{value:"login",children:"Login"}),e.jsx($,{value:"failed_login",children:"Failed Login"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-mobile-sm font-medium",children:"Entity"}),e.jsxs(je,{value:a.entity,onValueChange:h=>u("entity",h),children:[e.jsx(Ne,{children:e.jsx(be,{placeholder:"All entities"})}),e.jsxs(ye,{children:[e.jsx($,{value:"",children:"All entities"}),e.jsx($,{value:"booking",children:"Booking"}),e.jsx($,{value:"assignment",children:"Assignment"}),e.jsx($,{value:"user",children:"User"}),e.jsx($,{value:"company",children:"Company"}),e.jsx($,{value:"guard",children:"Guard"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-mobile-sm font-medium",children:"Start Date"}),e.jsx(T,{type:"date",value:a.startDate,onChange:h=>u("startDate",h.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-mobile-sm font-medium",children:"End Date"}),e.jsx(T,{type:"date",value:a.endDate,onChange:h=>u("endDate",h.target.value)})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(E,{variant:"outline",onClick:d,className:"w-full",children:"Clear Filters"})})]})})]}),n?e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((h,y)=>e.jsx(ge,{type:"list-item",className:"h-32"},y))}):l.length===0?e.jsx(b,{children:e.jsxs(w,{className:"p-8 text-center",children:[e.jsx(Ve,{className:"h-12 w-12 text-muted-foreground mx-auto mb-3"}),e.jsx("h3",{className:"text-mobile-base font-medium text-foreground mb-2",children:"No Audit Entries Found"}),e.jsx("p",{className:"text-mobile-sm text-muted-foreground",children:"Try adjusting your filters or check back later"})]})}):e.jsx("div",{className:"space-y-3 max-h-[600px] overflow-auto",children:l.map(h=>f({item:h,index:0}))})]})},Vs=({navigate:s})=>e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"safe-top px-mobile py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx(Q,{variant:"ghost",size:"sm",onClick:()=>s("/security"),hapticPattern:"light",className:"touch-target flex items-center justify-center p-2 -ml-2",children:e.jsx(W,{className:"h-6 w-6 text-foreground"})}),e.jsx("h2",{className:"text-mobile-lg font-semibold text-foreground",children:"Audit Trail"}),e.jsx("div",{className:"w-10"})]}),e.jsx(qs,{navigate:s})]})}),$s=()=>{const{user:s,loading:l,hasRole:n}=Y(),[m,x]=r.useState(window.location.hash.slice(1)||"/home");r.useEffect(()=>{const p=()=>{x(window.location.hash.slice(1)||"/home")};return window.addEventListener("hashchange",p),()=>window.removeEventListener("hashchange",p)},[]);const i=p=>{window.location.hash=p,x(p)};if(l)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-accent"})});if(!s)return e.jsx(Oe,{});const[t,c]=m.split("?"),a=t.split("/");if((["/company","/company-permits","/company-vehicles","/company-vehicles-new","/company-staff","/company-staff-new"].includes(t)||t.startsWith("/company-staff/")||t.startsWith("/company-vehicles/"))&&!n("company_admin"))return i("/home"),e.jsx(Ce,{navigate:i});switch(t){case"/home":case"/":return e.jsx(Ce,{navigate:i});case"/assignments":return e.jsx(bs,{navigate:i});case"/bookings":return e.jsx(ks,{navigate:i});case"/account":return e.jsx(_s,{navigate:i});case"/company":return e.jsx(Ss,{navigate:i});case"/company-permits":return e.jsx(Cs,{navigate:i});case"/company-vehicles":return e.jsx(As,{navigate:i});case"/company-staff":return e.jsx(Ps,{navigate:i});case"/company-staff-new":return e.jsx(Fs,{navigate:i});case"/company-vehicles-new":return e.jsx(Ue,{navigate:i});case"/apply":return e.jsx(Ds,{navigate:i});case"/security":return e.jsx(Us,{navigate:i});case"/audit-trail":return e.jsx(Vs,{navigate:i});default:if(t.startsWith("/assignment/")){const p=a[2];return e.jsx(ws,{navigate:i,assignmentId:p})}if(t.startsWith("/company-staff/")){const p=a[2];return e.jsx(Es,{navigate:i,staffId:p})}if(t.startsWith("/company-vehicles/")){const p=a[2];return e.jsx(Ue,{navigate:i,vehicleId:p})}return i("/home"),e.jsx(Ce,{navigate:i})}},Ms=new Ge,Rs=()=>(console.log("✅ Guard App component rendered"),e.jsx(He,{client:Ms,children:e.jsx(Je,{defaultTheme:"dark",storageKey:"blindado-guard-theme",children:e.jsx(We,{children:e.jsxs(Ye,{children:[e.jsx(Ke,{}),e.jsx(Qe,{}),e.jsx($s,{}),e.jsx("div",{id:"overlays"})]})})})}));console.log("🚀 Guard app initializing...");typeof window<"u"&&(console.log=()=>{},console.warn=()=>{},window.addEventListener("error",s=>{var n,m;fetch("https://isnezquuwepqcjkaupjh.supabase.co/functions/v1/performance_monitor",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({operation:"report",metrics:[{operation:"global_error",duration_ms:0,success:!1,error:((n=s.error)==null?void 0:n.message)||"Unknown error",metadata:{filename:s.filename,lineno:s.lineno,colno:s.colno,stack:(m=s.error)==null?void 0:m.stack,timestamp:new Date().toISOString(),app:"guard"}}]})}).catch(()=>{})}));Xe(document.getElementById("root")).render(e.jsx(Ze,{children:e.jsx(es,{children:e.jsx(Rs,{})})}));
